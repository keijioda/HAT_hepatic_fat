---
title: "HAT hepatic fat study"
output: github_document
---

```{r setup, include=FALSE}
# Setup -------------------------------------------------------------------

# Required packages
pacs <- c("tidyverse", "haven", "ggExtra", "ggResidpanel", "gtsummary", "flextable")
sapply(pacs, require, character.only = TRUE)

```

## Datasets

* A CSV file `HAT_KeyVariables.csv` includes PIDs, their assigned group and date randomized, n = 1008

* A CSV file `HAT_HFF.csv` includes PID, MRI dates and 3 variables about hepatic fat MRI measurements:
  * `hff`: Hepatic fat fraction
  * `FWHM`: Full width half maximum (the width of the peak measured at 50% of its maximum height), smaller the better
  * `sn`: Signal/noise ratio, higher the better
  * The file is in long format, having up to 2 MRI measurements per subject: n obs = 1932
  
* Demographic data: A SAS data file `final_n961_foodgroups_june2024.sas7bdat`
  * n = 961
  * Includes demographics (age, gender, race, education), BMI, and some dietary data

* Dietary data: A CSV file `HAT_GL_GI_by_FG_updated_080224.csv`
  * n.obs = 2845 from n = 961 distinct PIDs
  * Include glycemic load/index from various food groups by subject and visit
  
## Data check on hepatic fat

```{r read_hff, echo = FALSE, warning = FALSE, message = FALSE}
# Date randomized
# n distinct = 1008
randdate <- read_csv("./data/HAT_KeyVariables.csv") %>% 
  mutate(d_randomized = as.Date(d_randomized, format = "%d%b%Y")) %>% 
  select(pid, d_randomized)

# MRI measurement of hepatic fat
# n obs = 1932
# n distinct = 1008
# hfat <- read_csv("./data/HAT_HFF.csv") %>% 
hfat <- read_csv("./data/HAT_HFF_SN_fixed.csv") %>% 
  mutate(mridate = as.Date(mridate, format = "%d%b%y")) %>% 
  inner_join(randdate, by = "pid") %>% 
  mutate(prepost = ifelse(mridate <= d_randomized, 0, 1))

# Number of MRIs
n_MRI <- hfat %>% 
  group_by(pid) %>% 
  tally()
```

* The hepatic fat data file `HAT_HFF.csv` includes 1932 MRI measurements from 1008 distinct PIDs
  * The file does not have a variable indicating if a measurement is a pre- or post-intervention
  * The date of randomization was added from `HAT_KeyVariables.csv` to determine pre/post measurements

* Most of the subjects (n = 924) have two MRI measurements:
  * There were 3 subjects who have 2 measurements **after** randomization **[Decision needed]**
  
* There are 81 subjects who have only one MRI measurement
  * Among them, 75 subjects have only pre-intervention measurement **[Decision needed]**
  * Six subjects have only post-measurement **[Decision needed]**

* There are 3 subjects who did not have any MRI measurements (i.e., MRI date missing, measurement missing)

## Preliminary analysis on hepatic fat measurements

* Disclaimer: The following analysis was done regardless of pre/post measurements

* Descriptive statistics on `hff`, `FWHM`, `sn`:
  * The HFF value ranges from 0.04% to 54%, with mean of 10% (median 5.7%)
    * Its distribution appears to be very right-skewed
  * ~~Note the negative value of -1 on S/N ratio -- what does this indicate? **[Clarify]**~~
  * ~~There are 7 MRI measurements that have a value `-1` on S/N ratio~~
  * The issue of S/N = -1 has been resolved -- see the email correspondence on 1/27/25

```{r hff_descriptive, echo = FALSE}
hfat %>% 
  select(hff, FWHM, sn) %>% 
  summary()
```

### Distribution of HFF

* A histogram and a cumulative density function of HFF are shown below
  * Vertical dash lines divide HFF values into 5 groups at 5, 10, 20, and 30%
  * The distribution of HFF is highly right-skewed, but very smooth without apparent separating points
  * **[Decision needed]** What should we draw a line for outliers on HFF?

```{r hff_distrib, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 4}
p1 <- hfat %>% 
  ggplot(aes(x = hff)) +
  geom_histogram() +
  geom_vline(xintercept = c(0.05, 0.1, 0.2, 0.3), linetype = 2) +
  labs(x = "Hepatic fat fraction")

p2 <- hfat %>% 
  ggplot(aes(x = hff)) +
  stat_ecdf(geom = "step") +
  geom_vline(xintercept = c(0.05, 0.1, 0.2, 0.3), linetype = 2) +
  scale_y_continuous(n.breaks = 11) +
  labs(x = "Hepatic fat fraction", y = "Empirical CDF")

library(patchwork)
p1 + p2
```

* A frequency table of HFF (5 groups):
  * About 45% of measurements are "normal" having HFF <5%

```{r hff_freqtab, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 4}
hfat %>% 
  filter(!is.na(hff)) %>% 
  mutate(hff_cat = cut(hff, breaks = c(0, 0.05, 0.1, 0.2, 0.3, Inf)),
         hff_cat = factor(hff_cat, labels = c("Normal  : 0-5", "Mild    : 5-10", "Moderate: 10-20", "Severe  : 20-30", "Advanced: >30"))) %>% 
  group_by(hff_cat) %>% 
  tally() %>% 
  mutate(pct = n / sum(n) * 100)
```

### Change in HFF

* For those who have both pre- and post-measurements, changes in HFF value (post - pre) were calculated
* A histogram of change in HFF is shown below
  * Most of subjects have an absolute change <0.2

```{r hff_change, echo = FALSE, warning = FALSE, message = FALSE}
hfat_wide <- hfat %>% 
  filter(!is.na(mridate)) %>% 
  filter(!pid %in% c(15154629, 15217132, 15235033)) %>% 
  mutate(prepost = factor(prepost, labels = c("Pre", "Post"))) %>%
  select(pid, hff, FWHM, prepost) %>% 
  pivot_wider(names_from = prepost, values_from = c(hff, FWHM))

hfat_wide %>% 
  mutate(hff_diff = hff_Post - hff_Pre) %>% 
  ggplot(aes(x = hff_diff)) +
  geom_histogram(aes(y = after_stat(count / sum(count)))) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Change in HFF (post - pre)",
       y = "Percent")
```

* See the list below for those whose HFF value changed >0.2. There are 11 such subjects:
  * **[Clarify]** Is it likely to see such change in HFF during the study period?

```{r hff_change_list, echo = FALSE, warning = FALSE, message = FALSE}
hfat_wide %>% 
  mutate(hff_diff = hff_Post - hff_Pre) %>% 
  filter(abs(hff_diff) > .2) %>% 
  select(pid, hff_Pre, hff_Post, hff_diff)

pid_large_hff_change <- hfat_wide %>% 
  mutate(hff_diff = hff_Post - hff_Pre) %>% 
  filter(abs(hff_diff) > .2) %>% 
  distinct(pid)
```

* There are 23 subjects whose HFF value changed >0.15 (not shown here)


### S/N ratio and FWHM

* A scatterplot of S/N and FWHM is shown below, with histograms on margins.
  * Those measurements of S/N = -1 are shown red in the figure
  * Notice that both distributions are right-skewed
  * **[Decision needed]** Where should we draw lines for potential outliers?
    * For example, there are 18 measurements that have S/N < 100 (more noise) and FWHM > 0.6 (lower resolution)

```{r sn_fwhm_scatter, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 5, fig.height = 5}
p <- hfat %>% 
  ggplot(aes(x = sn, y = FWHM)) +
  geom_point(color = "black") +
  # geom_point(data = hfat[hfat$sn < 0,], aes(x = sn, y = FWHM), color = "red") +
  labs(x = "S/N")

ggMarginal(p, type = "histogram")
```

### Relationship between HFF and BMI

* A scatterplot between BMI and HFF is shown below
  * Both axes are log-scale, due to their skewed distributions
  * A smoothed trend curve is super-imposed (with 95% confidence intervals)

```{r hff_bmi_scatter, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 5, fig.height = 5}
# Subjects: n = 961
demog <- read_sas("./data/final_n961_foodgroups_june2024.sas7bdat") %>% 
  mutate(SexM  = factor(sex, labels = c("F", "M"))) %>% 
  mutate(Trt   = factor(randarm, labels = c("Cntrl", "Avocado"))) %>% 
  mutate(Educ3 = factor(Edu_New, labels = c("LTCollege", "College", "Postgrad"))) %>% 
  mutate(Race2 = factor(Race_New, labels = c("NonWhite", "White", "NonWhite", "NonWhite", "NonWhite")),
         Race2 = relevel(Race2, "White"),
         Race3 = factor(Race_New, labels = c("AA", "White", "Other", "Other", "Other")),
         Race3 = relevel(Race3, "White"))

hfat2 <- hfat %>% 
  left_join(demog %>% select(pid, bmi), by = "pid")

test <- hfat2 %>% 
  # filter(sn >= 100, FWHM <= 0.6) %>% 
  ggplot(aes(x = bmi, y = hff)) +
  geom_point() +
  scale_x_continuous(trans = "log10") +
  scale_y_continuous(trans = "log10") +
  geom_smooth() +
  labs(x = "BMI", y = "HFF")

ggMarginal(test, type = "histogram")
```

* The Pearson correlation coefficient between BMI and HFF (both log-scale) was r = 0.32
  * If MRI measurements of S/N < 100 and FWHM > 0.6 were removed, the correlation slightly reduced to r = 0.31

## Exploratory analysis on HFF vs GL/GI

* Based on dietary data, total GL/GI intake was calculated for each visit and then averaged for each subject
* After merging with demographic data and HFF data, there were n = 903 subjects
  * This excludes those who had 2 MRIs after randomization and those missing either pre/post-intervention MRIs or both

* Descriptive statistics on hepatic fat fraction (post-intervention only), GL and GI are shown below:

```{r hff_gl_gi_summary, echo = FALSE, warning = FALSE, message = FALSE}
# Subjects: n = 961
diet <- read_csv("./data/HAT_GL_GI_by_FG_updated_080224.csv")

# GL variables
GL_vars <- names(diet) %>% grep("_GL", ., value = TRUE)

# GI variables
GI_vars <- names(diet) %>% grep("_GI", ., value = TRUE)

# Average GL/GI by PID
glgi <- diet %>% 
  mutate(GL = rowSums(across(all_of(GL_vars)))) %>% 
  mutate(GI = rowSums(across(all_of(GI_vars)))) %>%
  group_by(cpartid) %>% 
  summarize(GL = mean(GL), GI = mean(GI)) %>% 
  rename(pid = cpartid)

# Using SPSS data file: n = 1008
diet_other <- read_spss("./data/mean intake of selected nutriient covariates.sav")

glgi2 <- glgi %>% 
  inner_join(diet_other, by = "pid")

# Inner-join yields n = 955 subjects
# There are 46 PIDs whose HFF post is missing
# There are  6 PIDs whose HFF pre  is missing
# After removing these, n = 903 subjects
df <- demog %>% 
  inner_join(glgi2) %>% 
  inner_join(hfat_wide) %>% 
  filter(!is.na(hff_Post)) %>% 
  filter(!is.na(hff_Pre)) 

# Energy adjustment
kcal_adjust <- function(data, var, energy, log=TRUE){
  if (missing(var))
    stop("Need to specify variable for energy-adjustment.")
  if (missing(energy))
    stop("Need to specify energy intake.")
  if (missing(data))
    stop("Need to specify a data frame.")
  df <- eval(substitute(data.frame(y = data$var, ea_y = data$var, kcal = data$energy)))
  count_negative <- sum(df$y < 0, na.rm=TRUE)
  if (count_negative > 0)
    warning("There are negative values in variable.")
  if(log) df$y[df$y > 0 & !is.na(df$y)] <- log(df$y[df$y > 0 & !is.na(df$y)])
  mod <- lm(y ~ kcal, data=df[df$y != 0, ])
  if(log){
    ea <- exp(resid(mod) + mean(df$y[df$y != 0], na.rm=TRUE))
    df$ea_y[!is.na(df$y) & df$y != 0] <- ea
  }
  else{
    ea <- resid(mod) + mean(df$y[df$y != 0], na.rm=TRUE)
    df$ea_y[!is.na(df$y) & df$y != 0] <- ea
  }
  return(df$ea_y)
}

df$SFA_ea       <- kcal_adjust(SFA,       kcal, data = df, log = FALSE)
df$addsugar_ea  <- kcal_adjust(addsugar,  kcal, data = df, log = FALSE)
df$availcarb_ea <- kcal_adjust(availcarb, kcal, data = df, log = FALSE)

df %>% 
  select(hff_Post, GL, GI) %>% 
  summary()
```

* Histograms of HFF, GL and GI are shown below
  * Note that the distribution of HFF is highly right-skewed
  * When HFF is used as the dependent variable, this will be log-transformed
  * **[Clarify]** There are some GL values > 300 and GI values > 3000. Are these values plausible? 
  
```{r hff_gl_gi_histograms, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 15, fig.height = 5}
hist_hff <- df %>% 
  ggplot(aes(x = hff_Post)) + 
  geom_histogram() +
  labs(x = "Hepatic fat fraction (post-intervention)")

hist_gl <- df %>% 
  ggplot(aes(x = GL)) + 
  geom_histogram() +
  labs(x = "Glycemic load")

hist_gi <- df %>% 
  ggplot(aes(x = GI)) + 
  geom_histogram() +
  labs(x = "Glycemic index")

hist_hff + hist_gl + hist_gi
```

* Scatterplots between HFF (post-intervention) and GL/GI are shown below
  * These plots are exploratory and not adjusted for any covariates
  * The y-axis (HFF) is on the log scale
  * A smoothed trend is overlaid for each plot
    * Please ignore the tail region of GL/GI where data are sparse and the confidence interval is wide
    * No apparent relationship with HFF (again, unadjusted)
  
```{r hff_gl_gi_scatter, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 5}
scatter_HFF_GL <- df %>% 
  ggplot(aes(x = GL, y = hff_Post)) +
  geom_point() +
  geom_smooth(span = 0.9) +
  scale_y_continuous(trans = "log10") +
  labs(x = "Glycemic load", y = "Hepatic fat fraction (log-scale)") +
  theme(legend.position = "bottom")

scatter_HFF_GI <- df %>% 
  ggplot(aes(x = GI, y = hff_Post)) +
  geom_point() +
  geom_smooth(span = 0.95) +
  scale_y_continuous(trans = "log10") +
  labs(x = "Glycemic index", y = "Hepatic fat fraction (log-scale)") +
  theme(legend.position = "bottom")

scatter_HFF_GL + scatter_HFF_GI
```

## Regression models of HFF on GL

* Regression models were run using log(post HFF) as the dependent variable and glycemic load (GL) as an independent variable of interest.
  * Because of its highly right-skewed distribution, HFF was log-transformed
  * GL values were divided by 10 (labelled as "GL/10" in the table below). Thus, its beta estimate is interpreted as a change in log(HFF) for a 10-unit change in GL. 

* Model 1 (or "base" model) below adjusts for basic demographic variables: gender, age, race (NH White/rest), education (less than college, college degree, postgraduate degree)
  * There was a significant positive association between HFF and GL. A 10-unit increment in GL gives a corresponding increment of HFF by 1.6% (i.e., $exp(0.016) = 1.016$ or 1.6% increase)
  * Males' HFF values were significantly higher than females by 68% ($exp(0.520) = 1.68$)
  * Non-Whites had significantly lower HFF value than White ($exp(-0.185) = 0.83$ or 17% lower)
  * Education was negatively associated with HFF
  
* In Model 2, BMI was added to the base model
  * BMI was significantly positively associated with HFF. A 1-unit increment of BMI corresponds to an increase of HFF by 6% (i.e., $exp(0.059) = 1.061$ or 6% increase)
  * The beta coefficient for GL was attenuated and became non-significant after adding BMI into the base model
 
* In Model 3, total energy (per 100 kcal) and SFA (gram, energy-adjusted) was added to the base model
  * Both kcal and SFA were not significantly associated with HFF
  * Glycemic load was not significantly associated with HFF, after further adjusting for kcal and SFA

```{r gl_models, echo = FALSE, warning = FALSE, message = FALSE}
# Change units
df_mod <- df %>% 
  mutate(GL10 = GL / 10,
         GI100 = GI / 100,
         kcal100 = kcal / 100)

# Model for GL
# Both control and intervention
fit_gl <- lm(log(hff_Post) ~ GL10 + SexM + age + Race2 + Educ3, data = df_mod)

# Base model with demographics
var_labs <- list(GL10 = "GL/10", SexM = "Sex", age = "Age", Race2 = "Race", Educ3 = "Education")

t1 <- tbl_regression(fit_gl, 
               label = var_labs,
               estimate_fun = label_style_number(digits = 3),
               pvalue_fun   = label_style_pvalue(digits = 3)) %>% 
  add_global_p(keep = TRUE, include = Educ3)

# Base + BMI
t2 <- update(fit_gl, .~. + bmi) %>%
  tbl_regression(label = c(var_labs, bmi = "BMI"),
                 estimate_fun = label_style_number(digits = 3),
                 pvalue_fun = label_style_pvalue(digits = 3)) %>% 
  add_global_p(keep = TRUE, include = Educ3)

# Base + dietary variables (including kcal) 
t3 <- update(fit_gl, .~. + kcal100 + SFA_ea) %>%
  tbl_regression(label = c(var_labs, 
                           kcal100 = "Energy (per 100 kcal)",
                           SFA_ea = "SFA, gram (energy-adjusted)"),
                 estimate_fun = label_style_number(digits = 3),
                 pvalue_fun = label_style_pvalue(digits = 3)) %>% 
  add_global_p(keep = TRUE, include = Educ3)

# Model comparisons
tbl_merge(tbls = list(t1, t2, t3),
          tab_spanner = c("**Model 1**", "**Model 2**", "**Model 3**")) %>% 
  modify_header(label = "**Variable**", 
                p.value_1 = "**p**", 
                p.value_2 = "**p**", 
                p.value_3 = "**p**") %>% 
  as_flex_table()

```


## Regression models of HFF on GI

* Regression models were run using log(post HFF) as the dependent variable and glycemic index (GI) as an independent variable of interest
  * Again, HFF was log-transformed
  * GI values were divided by 100 (labelled as "GI/10" in the table below). Thus, its beta estimate is interpreted as a change in log(HFF) for a 100-unit change in GI.

* Similarly to GL models, 3 models were run (see below)
  * In all models, glycemic index was not significantly associated with HFF

```{r gi_models, echo = FALSE, warning = FALSE, message = FALSE}

# Models for GI
# Both control and intervention
fit_gi <- lm(log(hff_Post) ~ GI100 + SexM + age + Race2 + Educ3, data = df_mod)

# Base model with demographics
var_labs <- list(GI100 = "GI/100", SexM = "Sex", age = "Age", Race2 = "Race", Educ3 = "Education")

t1 <- tbl_regression(fit_gi, 
               label = var_labs,
               estimate_fun = label_style_number(digits = 3),
               pvalue_fun   = label_style_pvalue(digits = 3)) %>% 
  add_global_p(keep = TRUE, include = Educ3)

# Base + BMI
t2 <- update(fit_gi, .~. + bmi) %>%
  tbl_regression(label = c(var_labs, bmi = "BMI"),
                 estimate_fun = label_style_number(digits = 3),
                 pvalue_fun = label_style_pvalue(digits = 3)) %>% 
  add_global_p(keep = TRUE, include = Educ3)

# Base + dietary variables (including kcal) 
t3 <- update(fit_gi, .~. + kcal100 + SFA_ea) %>%
  tbl_regression(label = c(var_labs, 
                           kcal100 = "Energy (per 100 kcal)",
                           SFA_ea = "SFA, gram (energy-adjusted)"),
                 estimate_fun = label_style_number(digits = 3),
                 pvalue_fun = label_style_pvalue(digits = 3)) %>% 
  add_global_p(keep = TRUE, include = Educ3)

# Model comparisons
tbl_merge(tbls = list(t1, t2, t3),
          tab_spanner = c("**Model 1**", "**Model 2**", "**Model 3**")) %>% 
  modify_header(label = "**Variable**", 
                p.value_1 = "**p**", 
                p.value_2 = "**p**", 
                p.value_3 = "**p**") %>% 
  as_flex_table()

```


## Notes

* Zoom meeting on 1/23/2025 (KL/GS/CH/KO)
  * ~~S/N = -1 indicates invalid values?~~ 
    * ~~Kristie can look up PIDs of those subjects~~
    * ~~Dr. Barnes can look into those images to check if HFF values make sense~~
    * **[Updated]** The issue of S/N = -1 has been resolved -- see the email correspondence on 1/27/25
  
  * It is plausible to see changes of HFF > 0.2 according to Dr. Barnes
    * Dig into past literature with similar intervention as well?
  
  * Any data on compliance on those with a large HFF change during study?
  
  * Need to determine cut-off values for HFF/FWHM/SN outliers

  * Possible covariates to be included in the model
    * Demographics (age/gender/race/education)
    * BMI (pre/post)
    * Any lifestyle variables? -- self-reported
    * Nutrient intake? -- total kcal, SFA (kcal base), sugar?, CHO?
      * Want to identify those overeating

  * KO to proceed analysis without excluding potential outliers for now -- Can exclude any outliers later
  * KL to communicate with Dr. Barnes
  * GS to look into nutrient data
  

